
Login
Trx limit 

Transaction Updated
Metrics Log Tracing

OpenTelementry
+ Grafana + Tempo + Prometheus + 

Otel Integration
- [x] Otel Integration + application.yml configuration + log format
- [x] Interceptor for traceId
- [x] SQL Logs
- [x] Other considerations for logging?
- [ ] AuditTrail Entries (need stud

Discussion
- [ ] Api Response Model (the need)
    - [ ] Why do we need?
    - [ ] Frontend changes
    - [ ] ErrorRespone + ProblemDetails & ResponseEntity

- [x] Checkstyle
    - [x] What to do next?
- [x] Metrics, Log, Tracing
    - [x] Need to consider this in my current work? Current work focus on log only
    - [x] If need consideration, then any existing tools that an be used/ to try?
    - [x] Else, should we try Grafana stack/ ELK stack? Requires Docker.

application.yml
datasource:
  url: jdbc:p6spy:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
  driver-class-name: com.p6spy.engine.spy.P6SpyDriver
  username: root
  password: root

jpa:
  database: h2
  hibernate:
    ddl-auto: update
  show-sql: false
  database-platform: org.hibernate.dialect.H2Dialect
  properties:
    hibernate:
      format_sql: true

management:
  endpoint:
    health:
      show-details: always
  health:
    db:
      enabled: true
    diskspace:
      enabled: true
  tracing:
    propagation:
      type: w3c
    enabled: true
    sampling:
      probability: 1.0
  observations:
    annotations:
      enabled: true
    http:
      server:
        requests:
          write-trace-header: true

logging:
  level:
    root: INFO
    p6spy: INFO
    com.p6spy.engine.spy.P6SpyDriver: DEBUG

build.gradle (dependencies)
//     https://mvnrepository.com/artifact/io.micrometer/micrometer-tracing-bridge-otel
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation("io.micrometer:micrometer-tracing-bridge-otel")
    implementation("io.micrometer:micrometer-observation")
    implementation('io.micrometer:micrometer-registry-prometheus')
    implementation('io.prometheus:prometheus-metrics-tracer-common')
//    // https://mvnrepository.com/artifact/io.opentelemetry/opentelemetry-exporter-zipkin
    implementation("io.opentelemetry:opentelemetry-exporter-zipkin")
    // https://mvnrepository.com/artifact/io.opentelemetry.instrumentation/opentelemetry-logback-mdc-1.0
    runtimeOnly("io.opentelemetry.instrumentation:opentelemetry-logback-mdc-1.0:2.18.1-alpha")
    // https://mvnrepository.com/artifact/p6spy/p6spy
    implementation("p6spy:p6spy:3.9.1")

Logback-spring.xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <springProperty scope="context"
                    name="APP_NAME"
                    source="spring.application.name"
                    defaultValue="unknown"/>

    <property name="PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} [service=%property{APP_NAME}] [traceId=%X{traceId:-}, spanId=%X{spanId:-}] [thread=%thread] [%class.%method] %-5level %logger{36} - %msg%n%ex"/>

    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${PATTERN}</pattern>
        </encoder>
    </appender>

    <appender name="SQL_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [traceId=%X{traceId:-}, spanId=%X{spanId:-}] [thread=%thread] SQL >>
                %msg%n
            </pattern>
        </encoder>
    </appender>

    <logger name="p6spy" level="INFO" additivity="false">
        <appender-ref ref="SQL_CONSOLE"/>
    </logger>

    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
    </root>
</configuration>


spy.properties
# Use the custom line format
modulelist=com.p6spy.engine.spy.P6SpyFactory,com.p6spy.engine.logging.P6LogFactory,com.p6spy.engine.outage.P6OutageFactory
logMessageFormat=com.p6spy.engine.spy.appender.CustomLineFormat
customLogMessageFormat=(%(executionTime)ms) %(sqlSingleLine)
executionThreshold=0
# Don't log categories we don't need
# https://p6spy.readthedocs.io/en/latest/configandusage.html#common-property-file-settings
excludecategories=debug,result,resultset,batch,commit,rollback,statement_prepare,statement_create,statement_close,info,connection,transaction
excludebinary=true
# Where to output (slf4j = to Logback)
appender=com.p6spy.engine.spy.appender.Slf4JLogger
# Log level for SLF4J logger
logLevel=INFO

TraceIdResponseFilter.java
package com.ngzhiyang.ifast_itp_assignment.aspect;

import io.micrometer.common.util.StringUtils;
import io.micrometer.tracing.Span;
import io.micrometer.tracing.TraceContext;
import io.micrometer.tracing.Tracer;
import jakarta.servlet.*;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.util.Optional;

@Component
public class TraceIdResponseFilter implements Filter {

    @Autowired
    private Tracer tracer;

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        HttpServletResponse httpResponse = (HttpServletResponse) response;

        // Get current span and extract trace ID
        Span currentSpan = tracer.nextSpan();
        Optional.of(currentSpan)
                .map(Span::context)
                .map(TraceContext::traceId)
                .filter(StringUtils::isNotBlank)
                .ifPresent(traceId -> httpResponse.setHeader("X-Trace-Id", traceId));

        chain.doFilter(request, response);
    }
}

3:03:35


Checkstyle Gradle
env[‘CI’] - default/ self-customised
1/2 - need test

- Test 1,2 & 3 testing
- Task registration in another file
- Logic in another file

Naming (checkStaged, checkCommitheckAll, checkUnstaged)

CICD - checkstyleCommit

checkstyle.gradle - register at build.gradle

Checking on all scripts
(Including Bash)


- Git push
CI/CD build cache - expiry
Other considerations

Markdown Editor

AssertUtil
- Refactor Util

Sandbox token
- Ekyc

Performance &&


AssertUtil - Proceed

Checkstyle
1. Move to separate files
2. Split into into different tasks
3. CI/CD use commit hash


At least - latest commit & previous commit (no fallback to default, but between two commits)

1. Double check & validate
2. CI/CD build cache - expiry


TraceId
1. JDBC + Insert +  As native as possible
2. Integrate into multimode
3. Double check (security & performance)

