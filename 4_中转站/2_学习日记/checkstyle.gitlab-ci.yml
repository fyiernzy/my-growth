# .gitlab/ci_templates/checkstyle.gitlab-ci.yml
stages:
  - validate

checkstyle:
  stage: validate
  tags:
    - my-ifast-pay-build-rke2

  image:
    name: gradle@sha256:f30921a2af0cca204583cabc319afcc5b7ca701702c19913815f5eef6f834191
    pull_policy: if-not-present
  allow_failure: true
  interruptible: true
  #  timeout: 10m
  #  retry: 1

  cache:
    key:
      prefix: "$CI_PROJECT_ID-$CI_COMMIT_REF_SLUG"
      files:
        - build.gradle
        - '**/build.gradle'
    paths:
      - 'violations-command-line-*.jar'
      - .gradle/
      - '**/.gradle/caches/'
      - '**/.gradle/wrapper/'
    policy: pull-push

  variables:
    GRADLE_USER_HOME: .gradle
    GIT_STRATEGY: fetch
    GIT_DEPTH: 0

  before_script:
    - chmod +x .gitlab/ci_templates/checkstyle.sh

  script:
    - .gitlab/ci_templates/checkstyle.sh

  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - '**/build/reports/checkstyle/'
      - gl-code-quality-report.json
    reports:
      codequality: gl-code-quality-report.json
    exclude:
      - '**/.gradle/**/*'
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" &&
               $CI_COMMIT_BRANCH   == "feature/checkstyle"'
      when: on_success

    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" &&
               $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == "feature/checkstyle" &&
               $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "feature/mr-test-checkstyle"'
      when: on_success

    - if: '$CI_PIPELINE_SOURCE == "web" &&
               $CI_COMMIT_BRANCH   == "feature/checkstyle"'
      when: manual

    - if: '$CI_PIPELINE_SOURCE == "schedule" &&
               $CI_COMMIT_BRANCH   == "feature/checkstyle"'
      when: on_success

    - when: never