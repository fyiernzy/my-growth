package com.ifast.ipaymy.batch.ws.job.card.ipay.writer;

import com.ifast.ipaymy.batch.service.feign.CardFeignService;
import com.ifast.ipaymy.modular.card.domain.entity.IPaySubscriptionBean;
import com.ifast.ipaymy.modular.card.service.constant.enums.IPay.IPaySubscriptionStatusEnum;
import com.ifast.ipaymy.modular.model.card.*;
import com.ifast.ipaymy.backend.util.SharedConstant;
import com.ifast.ipaymy.backend.util.validator.ValidatorUtils;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.core.JobParameter;
import org.springframework.batch.core.StepExecution;
import org.springframework.batch.item.Chunk;
import org.springframework.batch.item.ItemWriter;

import java.util.*;
import java.util.function.Function;
import java.util.stream.Collectors;

/**
 * Decide if subscription needs to be updated
 *
 * Subscribe or unsubscribe event to be done manually instead of automatically by batch job to avoid unintended
 * insertion or deletion of data
 */
@Slf4j
@RequiredArgsConstructor
public class IPaySubscriptionWriter implements ItemWriter<IPaySubscriptionBean> {

    private final StepExecution stepExecution;
    private final CardFeignService cardFeignService;

    private final static String DEACTIVATED_IDS = "deactivateIds";
    private final static String ACTIVATED_IDS = "activatedIds";

    @Override
    public void write(Chunk<? extends IPaySubscriptionBean> chunk) throws Exception {

        // Input: list of ipay subscription in MY iFAST PAY
        List<? extends IPaySubscriptionBean> subscriptionList = chunk.getItems();
        if (ValidatorUtils.isEmpty(subscriptionList)) {
            log.error("[IPaySubscriptionWriter] ipay_subscription bean list is empty");
            return;
        }

        // 1. get all registered ipay subscription from iPAY
        IPayWebhookSubscriptionsResponseModel iPaySubscriptionList = cardFeignService.getAllIPayWebhookSubscriptions();
        if (ValidatorUtils.isEmpty(iPaySubscriptionList.getWebhooks())) {
            log.error("[IPaySubscriptionWriter] iPay subscription model list is empty");
            return;
        }

        // 2. create map for better search
        Map<String, IPaySubscriptionBean> subscriptionMap = subscriptionList.stream()
                .collect(Collectors.toMap(IPaySubscriptionBean::getSubscriptionId, Function.identity()));

        Map<String, IPayWebhookSubscriptionResponseModel> iPaySubscriptionMap =
                iPaySubscriptionList.getWebhooks().stream()
                .collect(Collectors.toMap(IPayWebhookSubscriptionResponseModel::getSubscriptionId, Function.identity()));

        // 3. handle force updates
        Set<String> forceUpdateIdSet = new HashSet<>();
        List<UpdateIPaySubscriptionRequestModel> toForceUpdateRequestList = handleForceStatusUpdates(subscriptionMap,
                                                                                         iPaySubscriptionMap,
                                                                                         forceUpdateIdSet);

        // 4. filter out handled ids, and proceed with normal subscription details sync up
        Set<String> allIdSet = new HashSet<>();
        allIdSet.addAll(subscriptionMap.keySet());
        allIdSet.addAll(iPaySubscriptionMap.keySet());

        Set<String> remainingIdSet = new HashSet<>(allIdSet);
        remainingIdSet.removeAll(forceUpdateIdSet);
        List<UpdateIPaySubscriptionRequestModel> toUpdateRequestList = handleSubscriptionUpdates(subscriptionMap,
                                                                                      iPaySubscriptionMap,
                                                                                      remainingIdSet);

        // 5. send update to ipay
        updateIPaySubscriptions(toUpdateRequestList, toForceUpdateRequestList);
    }

    private void updateIPaySubscriptions(List<UpdateIPaySubscriptionRequestModel> toUpdateRequestList,
                                                             List<UpdateIPaySubscriptionRequestModel> toForceUpdateRequestList) {

        // 1. skip update request if both update lists are empty
        if (ValidatorUtils.isEmpty(toUpdateRequestList) && ValidatorUtils.isEmpty(toForceUpdateRequestList)) {
            log.info("[IPaySubscriptionWriter] No update needed");
            return;
        }

        // 2. Compile list of requests for bulk update
        List<UpdateIPaySubscriptionRequestModel> combinedRequestList = new ArrayList<>(toUpdateRequestList.size() + toForceUpdateRequestList.size());
        combinedRequestList.addAll(toUpdateRequestList);
        combinedRequestList.addAll(toForceUpdateRequestList);
        UpdateIPaySubscriptionsRequestModel updateIPaySubscriptionsRequestModel =
                new UpdateIPaySubscriptionsRequestModel().webhooks(combinedRequestList);

        // 3. Send update ipay subscriptions request
        IPaySubscriptionIdsModel iPaySubscriptionIdsModel =
                cardFeignService.updateIPaySubscription(updateIPaySubscriptionsRequestModel);
        log.info("[IPaySubscriptionWriter] Successfully updated subscription for: {}", iPaySubscriptionIdsModel.getIds());
    }

    /*
        Compare endpoint url and status for subscription data in iFAST PAY and iPAY, create request to sync iFAST PAY
        subscription details to iPAY if there is mismatch detected.

        Return empty list if there is no updates needed.
     */
    private List<UpdateIPaySubscriptionRequestModel> handleSubscriptionUpdates(
            Map<String, IPaySubscriptionBean> subscriptionMap,
            Map<String, IPayWebhookSubscriptionResponseModel> iPaySubscriptionMap,
            Set<String> idSet) {
        List<UpdateIPaySubscriptionRequestModel> toUpdateRequestList = new ArrayList<>();

        for (String id : idSet) {
            IPaySubscriptionBean subscription = subscriptionMap.get(id);
            IPayWebhookSubscriptionResponseModel ipaySubscription = iPaySubscriptionMap.get(id);

            // only handle updates for records that appear in both sides
            if (ValidatorUtils.isEmpty(subscription) || ValidatorUtils.isEmpty(ipaySubscription)) {
                continue;
            }

            if (ValidatorUtils.isNotEqualsIgnoreCase(subscription.getStatus().toValue(), ipaySubscription.getStatus()) ||
                    ValidatorUtils.isNotEqualsIgnoreCase(subscription.getEndpointUrl(), ipaySubscription.getEndpointUrl())) {
                toUpdateRequestList.add(createUpdateIPaySubscriptionRequestModel(subscription, subscription.getStatus()));
            }
        }

        return toUpdateRequestList;
    }

    /*
        Support for manual batch job trigger to force activate or deactivate specific subscription.
     */
    private List<UpdateIPaySubscriptionRequestModel> handleForceStatusUpdates(
            Map<String, IPaySubscriptionBean> subscriptionMap,
            Map<String, IPayWebhookSubscriptionResponseModel> iPaySubscriptionMap,
            Set<String> forceUpdateIdSet) {

        // 1. get activate ids and deactivate ids from job param
        Set<String> activateIdSet = getJobParamIdSet(ACTIVATED_IDS);
        Set<String> deactivateIdSet = getJobParamIdSet(DEACTIVATED_IDS);

        // 2. if there is no job param, return empty list
        if (ValidatorUtils.isEmpty(activateIdSet) && ValidatorUtils.isEmpty(deactivateIdSet)) {
            return new ArrayList<>();
        }

        // Note: activate and deactivate id cannot have duplicated ids
        Set<String> duplicatedIdSet = new HashSet<>(activateIdSet);
        duplicatedIdSet.retainAll(deactivateIdSet);

        if (ValidatorUtils.isNotEmpty(duplicatedIdSet)) {
            throw new IllegalArgumentException("Duplicate IDs found in both activate and deactivate sets: " + duplicatedIdSet);
        }

        List<UpdateIPaySubscriptionRequestModel> updateIPaySubscriptionRequestModelList = new ArrayList<>();

        // 2. handle force activate
        if (ValidatorUtils.isNotEmpty(activateIdSet)) {
            for (String activateId : activateIdSet) {
                if (allowForceUpdate(subscriptionMap, iPaySubscriptionMap, activateId,
                                     IPaySubscriptionStatusEnum.ACTIVE)) {
                    updateIPaySubscriptionRequestModelList.add(createUpdateIPaySubscriptionRequestModel(subscriptionMap.get(activateId),
                                                                                                     IPaySubscriptionStatusEnum.ACTIVE));
                    forceUpdateIdSet.add(activateId);
                }
            }
        }

        // 3. handle force deactivate
        if (ValidatorUtils.isNotEmpty(deactivateIdSet)) {
            for (String deactivateId : deactivateIdSet) {
                if (allowForceUpdate(subscriptionMap, iPaySubscriptionMap, deactivateId,
                                     IPaySubscriptionStatusEnum.INACTIVE)) {
                    updateIPaySubscriptionRequestModelList.add(createUpdateIPaySubscriptionRequestModel(subscriptionMap.get(deactivateId),
                                                                                                     IPaySubscriptionStatusEnum.INACTIVE));
                    forceUpdateIdSet.add(deactivateId);
                }
            }
        }

        return updateIPaySubscriptionRequestModelList;
    }

    /*
        Method to check if forced status update is allowed for the specific subscription

        Criteria for force update request:
            - subscription records must exist in both iFAST PAY and iPAY
            - target status must be different from iFAST PAY subscription status
            (Note: if target status is same as current iFAST PAY subscription status, we will fallback to normal
            subscription data sync)
     */
    private boolean allowForceUpdate(
            Map<String, IPaySubscriptionBean> subscriptionMap,
            Map<String, IPayWebhookSubscriptionResponseModel> iPaySubscriptionMap,
            String id,
            IPaySubscriptionStatusEnum targetStatus
    ) {
        IPaySubscriptionBean iPaySubscriptionBean = subscriptionMap.get(id);
        if (ValidatorUtils.isEmpty(iPaySubscriptionBean) || ValidatorUtils.isEqual(iPaySubscriptionBean.getStatus(), targetStatus)) {
            return false;
        }

        return iPaySubscriptionMap.containsKey(id);
    }

    private Set<String> getJobParamIdSet(String param) {
        Map<String, JobParameter<?>> jobParameterMap = stepExecution.getJobExecution().getJobParameters().getParameters();

        JobParameter<?> jobParameter = jobParameterMap.get(param);
        if (ValidatorUtils.isEmpty(jobParameter) || ValidatorUtils.isEmpty((String) jobParameter.getValue())) {
            // Early return: parameter not found or has no value
            return new HashSet<>();
        }

        String paramValue = (String) jobParameter.getValue();
        return Arrays.stream(paramValue.split(SharedConstant.COMMA))
                .map(String::trim)
                .filter(ValidatorUtils::isNotEmpty)
                .collect(Collectors.toSet());
    }

    private UpdateIPaySubscriptionRequestModel createUpdateIPaySubscriptionRequestModel(IPaySubscriptionBean iPaySubscriptionBean,
                                                                                        IPaySubscriptionStatusEnum status) {
        return new UpdateIPaySubscriptionRequestModel()
                .id(iPaySubscriptionBean.getId())
                .status(status.toValue());
    }
}
