@Configuration
public class DataSourceConfig {

    @Bean
    public DataSource dataSource(DataSourceProperties props) {
        // 1) build the real pool
        HikariDataSource hikari = props
                .initializeDataSourceBuilder()
                .type(HikariDataSource.class)
                .build();

        // 2) wrap in P6Spy to log parameters
        DataSource p6spyDs = new P6DataSource(hikari);

        // 3) wrap in OpenTelemetryDataSource for spans
        return new OpenTelemetryDataSource(p6spyDs);
    }
}


@Component
public class PrettySqlFormat implements MessageFormattingStrategy {
    private static final BasicFormatterImpl FORMATTER = new BasicFormatterImpl();

    @PostConstruct
    public void register() {
        // Tell P6Spy to use *this* class as its formatter
        com.p6spy.engine.spy.P6SpyOptions.getActiveInstance()
                .setLogMessageFormat(this.getClass().getName());
    }

    @Override
    public String formatMessage(
            int connectionId,
            String now,
            long elapsed,
            String category,
            String prepared,
            String sql,
            String url) {

        if (!Category.STATEMENT.getName().equals(category) || sql == null || sql.trim().isEmpty()) {
            return "";
        }

        // choose a style based on statement type
        String formatted = FORMATTER.format(sql);

        // include timing & category if you like
        return String.format("[%s] took %dms:\n%s", category, elapsed, formatted);
    }
}


/* ---------- Spring Boot core ---------- */
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-cache'
    implementation 'org.springframework.boot:spring-boot-starter-validation'

    /* ---------- Useful libraries ---------- */
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.8.9'
    implementation 'org.apache.commons:commons-lang3:3.18.0'
    implementation 'org.apache.commons:commons-collections4:4.5.0'
    implementation 'com.github.ben-manes.caffeine:caffeine:3.2.2'
    implementation 'org.mapstruct:mapstruct:1.6.3'
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.6.3'
    annotationProcessor 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok-mapstruct-binding:0.2.0'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'

    /* ---------- Testing ---------- */
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
    testImplementation 'com.intuit.karate:karate-junit5:1.4.1'
    testImplementation 'org.instancio:instancio-core:3.4.0'
    testImplementation 'org.instancio:instancio-junit:3.4.0'
    testImplementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.17.1'

    /* ---------- Database ---------- */
    runtimeOnly 'com.h2database:h2'
    // SQL logging via datasource-proxy (optional, leave if you use it)
    // implementation 'com.github.gavlyukovskiy:datasource-proxy-spring-boot-starter:1.12.0'
    implementation("p6spy:p6spy:3.9.1")
//    implementation("com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.12.0")

    /* ---------- Observability: OpenTelemetry + Micrometer ---------- */
    // Spring Boot starter for OTel (auto-configures SDK and common instrumentations)
    implementation 'io.opentelemetry.instrumentation:opentelemetry-spring-boot-starter'

    // JDBC & HikariCP instrumentation (align with your HikariCP version; Boot 3.5.x uses HikariCP 5.x)
    implementation 'io.opentelemetry.instrumentation:opentelemetry-jdbc'
    implementation 'io.opentelemetry.instrumentation:opentelemetry-hikaricp-3.0'

    // Logback appender & MDC (NO explicit versions; BOM applies). This fixes the ClassNotFound for v1_4 appender.
    runtimeOnly 'io.opentelemetry.instrumentation:opentelemetry-logback-appender-1.0'
    runtimeOnly 'io.opentelemetry.instrumentation:opentelemetry-logback-mdc-1.0'

    // OTel exporters (keep logging exporter for local dev visibility)
    implementation 'io.opentelemetry:opentelemetry-exporter-logging'

    // Micrometer <-> OpenTelemetry bridge and Prometheus registry
    implementation 'io.micrometer:micrometer-tracing-bridge-otel'
    implementation 'io.micrometer:micrometer-registry-prometheus'
    implementation 'io.micrometer:micrometer-observation'

    implementation('io.prometheus:prometheus-metrics-tracer-common')
    implementation("io.opentelemetry:opentelemetry-exporter-zipkin")



    otel:
  service:
    name: ifast-itp-assignment
  traces:
    exporter: none
  #  propagators:
  #    - tracecontext
  #  hikaricp:
  #    enabled: true
  #
  #  # ======= exporters =======
  #  traces:
  #    exporter: logging
  #  metrics:
  #    exporter: logging
  #  logs:
  #    exporter: logging

  instrumentation:
    common:
      db-statement-sanitizer:
        enabled: false
      default-enabled: false
    jdbc:
      enabled: true
      statement-sanitizer:
        enabled: false
    logback-appender:
      enabled: false
    logback-mdc:
      enabled: true


      logging:
  level:
    root: INFO
    io.opentelemetry.instrumentation.jdbc: DEBUG
    io.opentelemetry.javaagent.instrumentation.jdbc: DEBUG
    sql: DEBUG
    org.springframework.jdbc.core: DEBUG
#    p6spy: INFO
#    com.p6spy.engine.spy.P6SpyDriver: DEBUG


management:
  endpoint:
    health:
      show-details: always
  health:
    db:
      enabled: true
    diskspace:
      enabled: true
  tracing:
    propagation:
      type: w3c
    enabled: true
    sampling:
      probability: 1.0
  observations:
    annotations:
      enabled: true
    http:
      server:
        requests:
          write-trace-header: true



    jpa:
    database: h2
    hibernate:
      ddl-auto: update
    # Disable default Hibernate SQL logging
    show-sql: false
    database-platform: org.hibernate.dialect.H2Dialect
    properties:
      hibernate:
        format_sql: true


  datasource:
    #  Using p6spy
    #    url: jdbc:p6spy:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    #    driver-class-name: com.p6spy.engine.spy.P6SpyDriver

    #  Using normal database
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver

    #    #  Using OpenTelementry
    #    url: jdbc:otel:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    #    driver-class-name: io.opentelemetry.instrumentation.jdbc.OpenTelemetryDriver
    username: root
    password: root


    <springProperty scope="context"
                    name="APP_NAME"
                    source="spring.application.name"
                    defaultValue="unknown"/>

    <property name="CONSOLE_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} [service=${APP_NAME}] [traceId=%X{traceId:-}, spanId=%X{spanId:-}] [thread=%thread] [%logger{36}#%method] %-5level - %msg%n%ex"/>

    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
            <pattern>${CONSOLE_PATTERN}</pattern>
        </encoder>
    </appender>

    <appender name="OTel"
              class="io.opentelemetry.instrumentation.logback.appender.v1_0.OpenTelemetryAppender">
        <captureExperimentalAttributes>false</captureExperimentalAttributes>
        <captureMdcAttributes>*</captureMdcAttributes>
    </appender>

05082025
(Finished at 2:32p.m., 2:45:06) AssertUtil
- [x] Validate and implement
- [x] Unit Tests
- [x] MR + Code Review
    - [x] Question
    - [x] Date Time comparison
    - [x] (Deprecated) isEqualsCaseSensitive for string

5:50p.m., 2:32:34
Logging
- [x] SQL Logging research
    - [x] Datasource Proxy
    - [x] OpenTelementry JDBC
- [x] SQL Logging changes (depending on the previous task)
- [x] Noise logging
- [x] Duplicated Logging
- [x] Customized Logging
- [ ] Integrate into ifastpay
- [ ] Validate the code

Gradle Script
- [ ] Research on splitting into new gradle file
- [ ] Split into more functions
    - [ ] CheckstyleStage, checkstyleUnstaged, checkstyleCommit (default = previous commit, or range or branch)
    - [ ] checkstyleAll - use checkstyleMain
    - [ ] cheeckstyleFiles (underlying mechanism)
- [ ] YML file configuration (between 2 commits & cache)
- [ ] Studying the code & fix the issue/ performance
- [ ] Clean up commit + reword + MR


Prompt
Show me the modern, latest, industrial-level, actively maintained version of SQL logger that is widely adopted and highly recommended nowadays

My requirement: 1. Need to customize formatting 2. Need to log parameters in dev and doesn't log parameters at prod 3. Need to show execution time 4. Be able to show query for QueryDSL, Hibernate, EntityManager. 5. Slight performance overhead is acceptable 6. Slight setup overhead is acceptable


